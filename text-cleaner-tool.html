<script>
    // معالجة الملفات المرفوعة
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('fileName').innerText = "تم تحميل ملف: " + file.name;
        const reader = new FileReader();

        if (file.name.endsWith('.docx')) {
            reader.onload = function(event) {
                mammoth.extractRawText({arrayBuffer: event.target.result})
                    .then(function(result) {
                        document.getElementById('inputText').value = result.value;
                    })
                    .catch(function(err) { alert("حدث خطأ أثناء قراءة ملف الوورد"); });
            };
            reader.readAsArrayBuffer(file);
        } else {
            reader.onload = function(event) {
                document.getElementById('inputText').value = event.target.result;
            };
            reader.readAsText(file);
        }
    });

    function processText() {
        let text = document.getElementById('inputText').value;
        if (!text) { alert("يرجى إدخال نص أو اختيار ملف أولاً"); return; }

        // 1. حذف الروابط - تحديث ليشمل t.me وأي دومين مع مسارات
        if (document.getElementById('delLinks').checked) {
            //Regex مطور لصيد الروابط بجميع أشكالها حتى بدون http
            const globalUrlPattern = /(https?:\/\/[^\s]+)|(www\.[^\s]+)|([a-zA-Z0-9][-a-zA-Z0-9]*\.[a-z]{2,}(?:\/[^\s]*)?)/gi;
            text = text.replace(globalUrlPattern, '');
        }

        // 2. حذف الإيموجي والرموز - تحديث ليشمل الأسهم والرموز الخاصة
        if (document.getElementById('delEmoji').checked) {
            // نطاق شامل لكل الرموز التعبيرية والرموز الغرافيكية بما فيها الأسهم
            const emojiPattern = /[\u{1F000}-\u{1F9FF}]|[\u{2100}-\u{27BF}]/gu;
            text = text.replace(emojiPattern, '');
        }

        // 3. حذف الأرقام
        if (document.getElementById('delNumbers').checked) {
            text = text.replace(/[0-9٠-٩]/g, '');
        }

        // 4. حذف النصوص (الحروف)
        if (document.getElementById('delText').checked) {
            text = text.replace(/[a-zA-Z\u0600-\u06FF]/g, '');
        }

        // تنظيف المسافات الفارغة الناتجة عن الحذف لتحسين المظهر
        text = text.split('\n')
                   .map(line => line.trim()) 
                   .filter(line => line.length > 0)
                   .join('\n');

        document.getElementById('output').value = text;
    }

    function downloadText() {
        const text = document.getElementById('output').value;
        if (!text) { alert("لا يوجد محتوى لتحميله"); return; }
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const anchor = document.createElement('a');
        anchor.download = 'cleaned_content.txt';
        anchor.href = window.URL.createObjectURL(blob);
        anchor.click();
    }
</script>
